<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Web安全|SQL注入 | 他年少如歌</title><meta name="description" content="SQL注入基础介绍SQL注入SQL注入就是指WEB应用程序对用户输入数据的合法性没有判断，前端传入后端的参数是攻击者可控的，并且参数带入数据库查询，攻击者可以通过构造不同的SQL语句来实现对数据库的任意操作。下面以PHP语句为例: $query&#x3D;&quot;select * from users where id&#x3D;$_get[&#39;id&#39;]&quot;; 由于这里的参数id可控，且带入"><meta name="keywords" content="网络安全"><meta name="author" content="他年少如歌"><meta name="copyright" content="他年少如歌"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://chakalake.gitee.io/posts/15480/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><meta property="og:type" content="article"><meta property="og:title" content="Web安全|SQL注入"><meta property="og:url" content="https://chakalake.gitee.io/posts/15480/"><meta property="og:site_name" content="他年少如歌"><meta property="og:description" content="SQL注入基础介绍SQL注入SQL注入就是指WEB应用程序对用户输入数据的合法性没有判断，前端传入后端的参数是攻击者可控的，并且参数带入数据库查询，攻击者可以通过构造不同的SQL语句来实现对数据库的任意操作。下面以PHP语句为例: $query&#x3D;&quot;select * from users where id&#x3D;$_get[&#39;id&#39;]&quot;; 由于这里的参数id可控，且带入"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/HCLonely/hclonely.github.io/img/Butterfly/019.webp"><meta property="article:published_time" content="2019-09-19T04:25:42.000Z"><meta property="article:modified_time" content="2021-08-12T08:49:38.907Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="prev" title="Kali|MSF基本操作(更新ing)" href="https://chakalake.gitee.io/posts/18503/"><link rel="next" title="python学习|python简介" href="https://chakalake.gitee.io/posts/20980/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2021-08-12 16:49:38'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://cdn.jsdelivr.net/gh/Chocolate1999/cdn/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">40</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">3</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">14</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/bangumis/"><i class="fa-fw fab fa-youtube"></i><span> 番剧</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/box/"><i class="fa-fw fab fa-xbox"></i><span> 聚宝盒</span></a></div><div class="menus_item"><a class="site-page" href="/talk/"><i class="fa-fw far fa-comment"></i><span> 微语</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw far fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw far fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SQL注入基础"><span class="toc-number">1.</span> <span class="toc-text">SQL注入基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍SQL注入"><span class="toc-number">1.1.</span> <span class="toc-text">介绍SQL注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL注入原理"><span class="toc-number">1.2.</span> <span class="toc-text">SQL注入原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL知识点"><span class="toc-number">1.3.</span> <span class="toc-text">MySQL知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常见注入分类"><span class="toc-number">1.4.</span> <span class="toc-text">常见注入分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#注入点"><span class="toc-number">1.4.1.</span> <span class="toc-text">注入点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据提交方式"><span class="toc-number">1.4.2.</span> <span class="toc-text">数据提交方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行效果"><span class="toc-number">1.4.3.</span> <span class="toc-text">执行效果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#搜索性注入"><span class="toc-number">2.</span> <span class="toc-text">搜索性注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#搜索型注入简介与原理"><span class="toc-number">2.1.</span> <span class="toc-text">搜索型注入简介与原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#搜索型注入判断"><span class="toc-number">2.2.</span> <span class="toc-text">搜索型注入判断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#搜索型注入实战"><span class="toc-number">2.3.</span> <span class="toc-text">搜索型注入实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GET型注入"><span class="toc-number">2.3.1.</span> <span class="toc-text">GET型注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POST型注入"><span class="toc-number">2.3.2.</span> <span class="toc-text">POST型注入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#union注入"><span class="toc-number">3.</span> <span class="toc-text">union注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#union注入攻击"><span class="toc-number">3.1.</span> <span class="toc-text">union注入攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#union注入代码分析"><span class="toc-number">3.2.</span> <span class="toc-text">union注入代码分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Boolean注入"><span class="toc-number">4.</span> <span class="toc-text">Boolean注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Boolean注入攻击"><span class="toc-number">4.1.</span> <span class="toc-text">Boolean注入攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Boolean注入代码分析"><span class="toc-number">4.2.</span> <span class="toc-text">Boolean注入代码分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#报错注入"><span class="toc-number">5.</span> <span class="toc-text">报错注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#报错注入攻击"><span class="toc-number">5.1.</span> <span class="toc-text">报错注入攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#报错注入代码分析"><span class="toc-number">5.2.</span> <span class="toc-text">报错注入代码分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#时间注入"><span class="toc-number">6.</span> <span class="toc-text">时间注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#时间注入攻击"><span class="toc-number">6.1.</span> <span class="toc-text">时间注入攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#时间注入代码分析"><span class="toc-number">6.2.</span> <span class="toc-text">时间注入代码分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#堆叠查询"><span class="toc-number">7.</span> <span class="toc-text">堆叠查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#堆叠查询注入攻击"><span class="toc-number">7.1.</span> <span class="toc-text">堆叠查询注入攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#堆叠查询注入代码分析"><span class="toc-number">7.2.</span> <span class="toc-text">堆叠查询注入代码分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二次注入"><span class="toc-number">8.</span> <span class="toc-text">二次注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#二次注入攻击"><span class="toc-number">8.1.</span> <span class="toc-text">二次注入攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二次注入代码分析"><span class="toc-number">8.2.</span> <span class="toc-text">二次注入代码分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#宽字节注入"><span class="toc-number">9.</span> <span class="toc-text">宽字节注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#宽字节注入攻击"><span class="toc-number">9.1.</span> <span class="toc-text">宽字节注入攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#宽字节注入代码分析"><span class="toc-number">9.2.</span> <span class="toc-text">宽字节注入代码分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cookie注入"><span class="toc-number">10.</span> <span class="toc-text">cookie注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#cookie注入攻击"><span class="toc-number">10.1.</span> <span class="toc-text">cookie注入攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cookie注入代码分析"><span class="toc-number">10.2.</span> <span class="toc-text">cookie注入代码分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#base64注入"><span class="toc-number">11.</span> <span class="toc-text">base64注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#base64注入攻击"><span class="toc-number">11.1.</span> <span class="toc-text">base64注入攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#base64注入代码分析"><span class="toc-number">11.2.</span> <span class="toc-text">base64注入代码分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#XFF注入"><span class="toc-number">12.</span> <span class="toc-text">XFF注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#XFF注入攻击"><span class="toc-number">12.1.</span> <span class="toc-text">XFF注入攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XFF注入代码分析"><span class="toc-number">12.2.</span> <span class="toc-text">XFF注入代码分析</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div id="web_bg" data-type="photo"></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/HCLonely/hclonely.github.io/img/Butterfly/019.webp)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">他年少如歌</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/bangumis/"><i class="fa-fw fab fa-youtube"></i><span> 番剧</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/box/"><i class="fa-fw fab fa-xbox"></i><span> 聚宝盒</span></a></div><div class="menus_item"><a class="site-page" href="/talk/"><i class="fa-fw far fa-comment"></i><span> 微语</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw far fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw far fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Web安全|SQL注入</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2019-09-19 12:25:42"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2019-09-19</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-08-12 16:49:38"><i class="fas fa-history fa-fw"></i> 更新于 2021-08-12</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="SQL注入基础"><a href="#SQL注入基础" class="headerlink" title="SQL注入基础"></a>SQL注入基础</h1><h2 id="介绍SQL注入"><a href="#介绍SQL注入" class="headerlink" title="介绍SQL注入"></a>介绍SQL注入</h2><p>SQL注入就是指WEB应用程序对用户输入数据的合法性没有判断，前端传入后端的参数是攻击者可控的，并且参数带入数据库查询，攻击者可以通过构造不同的SQL语句来实现对数据库的任意操作。下面以PHP语句为例:</p>
<p><code>$query=&quot;select * from users where id=$_get[&#39;id&#39;]&quot;;</code></p>
<p>由于这里的参数id可控，且带入数据库查询，所以非法用户可以任意拼接sql语句进行攻击。</p>
<p>SQL注入按照不同的分类方法可以分为很多种，如报错注入、盲注、Union注入等。</p>
<h2 id="SQL注入原理"><a href="#SQL注入原理" class="headerlink" title="SQL注入原理"></a>SQL注入原理</h2><p>SQL注入漏洞产生满足条件：</p>
<p>■参数用户可控：前端传给后端的参数内容是用户可以控制的。</p>
<p>■参数带入数据库查询：传入的参数拼接到SQL语句，且带入数据库查询。</p>
<p>当传入的ID参数为1’时，数据库执行的代码如下所示：</p>
<p><code>select * from users where id=1&#39;</code></p>
<p>这不符合数据库语法规范，所以会报错。</p>
<p>当传入的ID参数为and 1=1时，执行的SQL语句如下所示</p>
<p><code>select * from users where id=1 and 1=1</code></p>
<p>因为1=1为真，且where语句中的id=1也为真，所以页面会返回与id=1相同的结果。</p>
<p>当传入的ID参数为and 1=2时，由于1=2不成立，所以返回假，页面就会返回与id=1不同的结果。</p>
<p>由此可以初步判断ID参数存在SQL注入漏洞，攻击者可以进一步拼接SQL语句进行攻击，致使数据库信息泄露，甚至进一步获取服务器的权限等。</p>
<h2 id="MySQL知识点"><a href="#MySQL知识点" class="headerlink" title="MySQL知识点"></a>MySQL知识点</h2><p>在MySQL5.0版本之后，MySQL默认在数据库中存放一个information_schema的数据库，在该库中，务必牢记三个表名，分别是<strong>schemata</strong>，tables和<strong>columns</strong>。</p>
<p>schemata表存储该用户创建的所有数据库的库名，该表中记录数据库库名的字段名为schemata_name。</p>
<p><img src= "/img/loading.gif" data-src="https://wx1.sinaimg.cn/mw1024/006rXvS1ly1g7ff77zgukj30xb0dv427.jpg" alt="img"><br>​tables表存储该用户创建的库名和表名，该表中记录数据库名和表名的字段名分别为table_schema和table_name。</p>
<p><img src= "/img/loading.gif" data-src="https://wx4.sinaimg.cn/mw1024/006rXvS1ly1g7ff787syyj31950esq4z.jpg" alt=""><br>​columns表存储该用户创建的所有数据库的库名、表名和字段名，该表中记录数据库库名、表名和字段名的字段名分别为table_schema，table_name和column_name。<br><img src= "/img/loading.gif" data-src="https://wx4.sinaimg.cn/mw1024/006rXvS1ly1g7ff77z7unj319d0eo0uy.jpg" alt=""><br>​常用的MySQL查询语句和函数如下：</p>
<p> 1、MySQL查询语句</p>
<p>■在不知道任何条件时：</p>
<p><code>select 要查询的字段名 from 库名.表名</code></p>
<p>■在知道一条已知条件时：</p>
<p><code>select 要查询的字段名 from 库名.表名 where 已知条件的字段名=&#39;已知条件的值&#39;</code></p>
<p>■在知道两条已知条件时：</p>
<p><code>select 要查询的字段名 from 库名.表名 where 已知条件1的字段名=&#39;已知条件1的值&#39; and 已知条件2的字段名=&#39;已知条件2的值&#39;</code></p>
<p>2、limit的用法</p>
<p>limit的使用格式为limit m,n，其中m是指记录开始的地方，从0开始表示第一条记录；n是指取n条记录。</p>
<p>3、需要记住的几个函数</p>
<p>​    select database();    当前网站使用的数据库</p>
<p>​    select version();    当前MySQL版本</p>
<p>​    select user();    当前MySQL用户</p>
<p>​    select @@basedir;    查询数据库路径，用来上传webshell</p>
<p>​    select @@global.version_compile_os    查询当前操作系统    </p>
<p>4、注释符</p>
<p>​    MySQL中，常见的注释符表达方式：#    –+    /**/。    </p>
<p>5、内联注释</p>
<p>​    内敛注释的形式为/*!code*/，内联注释可用于整个SQL语句中，常用来绕过WAF检测。</p>
<p><code>index.php?id=-15 /*!union*/ /*!select*/ 1,2,3</code></p>
<h2 id="常见注入分类"><a href="#常见注入分类" class="headerlink" title="常见注入分类"></a>常见注入分类</h2><h3 id="注入点"><a href="#注入点" class="headerlink" title="注入点"></a>注入点</h3><p>1、数字型注入</p>
<p>当输入的参数为整型时，存过存在注入漏洞，则可以认为是数字型注入。</p>
<p>测试步骤：</p>
<p>①加单引号，URL：<a href="http://www.text.com/text.php?id=3&#39;" target="_blank" rel="noopener">www.text.com/text.php?id=3&#39;</a></p>
<p>对应的sql：select * from table where id=3’ 这时sql语句出错，程序无法正常从数据库中查询出数据，就会抛出异常。</p>
<p>②加and 1=1，URL：<a href="http://www.text.com/text.php?id=3" target="_blank" rel="noopener">www.text.com/text.php?id=3</a> and 1=1</p>
<p>对应的sql：seelct * from table where id=3 and 1=1 语句执行正常，与原始页面无任何差异。</p>
<p>③加and 1=2，URL：<a href="http://www.text.com/text.php?id=3" target="_blank" rel="noopener">www.text.com/text.php?id=3</a> and 1=2 语句可以正常执行，但是无法查询出结果，所以返回数据与原始网页存在差异。</p>
<p>如果满足以上三点，则可以判断该URL存在数字型注入。</p>
<p>2、字符型注入</p>
<p>当输入的参数为字符串时，成为字符型。字符型和数字型最大的一个区别在于，数字型不需要单引号来闭合，而字符串一般需要通过单引号来闭合的。</p>
<p>例如数字型语句：select * from table where id=3 </p>
<p>则字符型如下：select * from table where name=’admin’</p>
<p>因此，在构造payload时通过闭合单引号可以成功执行语句</p>
<p>测试步骤：</p>
<p>①加单引号：select * from table where name=’admin’’</p>
<p>由于加单引号后变成三个单引号，则无法执行，程序会报错。</p>
<p>②加’and 1=1 此时sql语句为：select * from table where name=’admin ‘and 1=1’，也无法进行注入，还需要注释符号将其绕过。</p>
<p>因此，构造语句为：select * from table where name=’admin’ and 1=1– ‘可成功执行返回结果正确。</p>
<p>③加’and 1=2 – sql语句为：select * from table where name=’admin’and 1=2– ‘则会报错。</p>
<p>如果满足以上三点，可以判断该url为字符型注入。</p>
<p>3、搜索型注入</p>
<p>在进行数据搜索时没有过滤搜索参数，一般在链接地址中有”keyword=关键字”，有的不显示在链接地址里面，而是直接通过搜索框表单提交。</p>
<p>对应是sql为：select * from table where column like ‘%关键字%’</p>
<h3 id="数据提交方式"><a href="#数据提交方式" class="headerlink" title="数据提交方式"></a>数据提交方式</h3><p>1、get注入</p>
<p>提交数据的方式时get，注入点的位置在get参数部分。</p>
<p>2、post注入</p>
<p>使用post方式提交数据，注入点位置在post数据部分，常发生在表单中。</p>
<p>3、cookie注入</p>
<p>http请求的时候会带上客户端的cookie，注入点存在cookie当中的某个字段中。</p>
<p>4、http头部注入</p>
<p>注入点在http请求头部的某个字段中。比如在user-agent字段中。严格的讲，cookie其实应该也是算头部注入的一种形式。应为在http请求的时候，cookie是头部的一个字段。</p>
<h3 id="执行效果"><a href="#执行效果" class="headerlink" title="执行效果"></a>执行效果</h3><p>1、基于布尔的盲注</p>
<p>既可以根据返回页面判断条件真假的注入。</p>
<p>2、基于时间的盲注</p>
<p>即不能根据页面返回内容判断任何信息，用条件语句查看时间延迟语句是否执行（即页面返回时间是否增加）来判断。</p>
<p>3、基于报错注入</p>
<p>即页面返回错误信息，或者把注入的语句的结果直接返回在页面中。</p>
<p>4、联合查询注入</p>
<p>可以使用union的情况下的注入。</p>
<p>5、堆查询注入</p>
<p>可以同时执行多条语句的执行时的注入。</p>
<p>6、宽字节注入</p>
<h1 id="搜索性注入"><a href="#搜索性注入" class="headerlink" title="搜索性注入"></a>搜索性注入</h1><h2 id="搜索型注入简介与原理"><a href="#搜索型注入简介与原理" class="headerlink" title="搜索型注入简介与原理"></a>搜索型注入简介与原理</h2><p>1、简介</p>
<p>一些网站为了方便用户查找网站的资源，都对用户提供了搜索的功能，因为是搜索功能，程序员在编写代码时往往都忽略了对其变量（参数）的过滤，而且这样的漏洞在在国内系统中普遍存在。</p>
<p>其中又分为POST/GET，<strong>GET型的一般是用在网站上的搜索，而POST则在用户登陆</strong>，可以从form表单的method=”get”属性区分是get还是post。搜索型注入又称为文本框注入。</p>
<p>2、原理</p>
<p><code>$sql=&quot;select * from user where password like &#39;%$fendo%&#39; order by password&quot;;</code></p>
<p>根据用户输入的pwd在user表中找到对应的password，正常用户当然会输入例如admin、fendo等等。但是如果有人输入这样的内容呢？</p>
<p><code>%&#39;and 1=1 and &#39;%&#39;=&#39;</code></p>
<p>这样的 话sql语句就变成了这样：</p>
<p><code>select * from user where password like &#39;%fendo%&#39;and 1=1 and &#39;%&#39;=&#39;%&#39;order by password</code></p>
<p>存在sql注入。</p>
<h2 id="搜索型注入判断"><a href="#搜索型注入判断" class="headerlink" title="搜索型注入判断"></a>搜索型注入判断</h2><p>判断搜索型注入的方法：</p>
<p>1、搜索keywords’，如果出错的话，有90%的可能性存在漏洞。</p>
<p>2、搜索keywords%’，如果同样出错的话，就有95% 可能性存在漏洞。</p>
<p>3、搜索keywords%’and 1=1 and ‘%’=’（这个语句功能就相当于普通sql注入的and 1=1）看返回情况。</p>
<p>4、搜索keywords%’and 1=2 and ‘%’=’（这个语句功能就相当于普通sql注入的and 1=2）看返回情况。</p>
<p>下面这样写也可以：</p>
<p><code>%&#39; and 1=1 -- &#39;</code></p>
<h2 id="搜索型注入实战"><a href="#搜索型注入实战" class="headerlink" title="搜索型注入实战"></a>搜索型注入实战</h2><h3 id="GET型注入"><a href="#GET型注入" class="headerlink" title="GET型注入"></a>GET型注入</h3><p>测试源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$pwd=$_GET[<span class="string">'pwd'</span>];</span><br><span class="line">$conn=mysql_connect(<span class="string">"127.0.0.1"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);<span class="comment">//连接mysql数据库</span></span><br><span class="line"><span class="keyword">if</span>($conn)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"连接数据库成功！"</span>;</span><br><span class="line">&#125;<span class="comment">//判断连接</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">mysql_select_db(<span class="string">'test'</span>,$conn);<span class="comment">//选择数据库</span></span><br><span class="line">$sql=<span class="string">"select * from users where password like '%$pwd%' order by password"</span>;<span class="comment">//字符型搜索语句</span></span><br><span class="line">$result=mysql_query($sql);</span><br><span class="line"><span class="keyword">while</span>($row=mysql_fetch_array($result))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"用户ID："</span>.$row[<span class="string">'id'</span>].<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"用户名："</span>.$row[<span class="string">'username'</span>].<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"用户密码："</span>.$row[<span class="string">'password'</span>].<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"用户邮箱："</span>.$row[<span class="string">'email'</span>].<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line">mysql_close($conn);<span class="comment">//关闭数据库连接</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"你当前执行的sql语句为："</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> $sql;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>1、判断字段数</p>
<p><code>%&#39; union select 1,2,3,4,......and &#39;%&#39;=&#39;</code><br><img src= "/img/loading.gif" data-src="https://wx2.sinaimg.cn/mw690/006rXvS1ly1g7exdjud5sj30r60e1mxv.jpg" alt=""></p>
<p>2、判断表名</p>
<p><img src= "/img/loading.gif" data-src="https://wx3.sinaimg.cn/mw690/006rXvS1ly1g7exdk3cboj30tg0b8gmb.jpg" alt=""><br>把admin这个表逐次更换，直到他不报错为止，就说明这个表存在。如：user、users等等。</p>
<h3 id="POST型注入"><a href="#POST型注入" class="headerlink" title="POST型注入"></a>POST型注入</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$name&#x3D;$_POST[&#39;n&#39;];</span><br><span class="line">$pass&#x3D;$_POST[&#39;p&#39;];</span><br><span class="line">$conn&#x3D;mysql_connect(&#39;127.0.0.1&#39;,&#39;root&#39;,&#39;root&#39;);</span><br><span class="line">if($conn)&#123;</span><br><span class="line">	echo &quot;mysql连接成功&quot;;</span><br><span class="line">	echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">mysql_select_db(&#39;test&#39;,$conn);</span><br><span class="line">$sql&#x3D;&quot;select * from users where username&#x3D;&#39;$name&#39; and password&#x3D;&#39;$pass&#39;&quot;;</span><br><span class="line">$result&#x3D;mysql_query($sql);</span><br><span class="line">mysql_close($conn);</span><br><span class="line">while($row&#x3D;mysql_fetch_array($result))&#123;</span><br><span class="line">	echo &quot;用户ID:&quot;.$row[&#39;id&#39;].&quot;&lt;br&gt;&quot;;</span><br><span class="line">	echo &quot;用户名:&quot;.$row[&#39;username&#39;].&quot;&lt;br&gt;&quot;;</span><br><span class="line">	echo &quot;用户密码:&quot;.$row[&#39;password&#39;].&quot;&lt;br&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">echo &quot;当前执行的sql：&quot;.$sql;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;form action&#x3D;&quot;&quot;method&#x3D;&quot;POST&quot;&gt;</span><br><span class="line">	账号：&lt;input name&#x3D;&quot;n&quot; type&#x3D;&quot;text&quot; &#x2F;&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">	密码：&lt;input name&#x3D;&quot;p&quot; type&#x3D;&quot;text&quot; &#x2F;&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">	&lt;input name&quot;&quot; type&#x3D;&quot;submit&quot; value&#x3D;&quot;提交&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br></pre></td></tr></table></figure>

<p>①判断是否 存在sql注入,用php万能密码进行测试，在用户名里输入万能密码如果没报错，就说明存在SQL注入。<code>&#39; or 1=1 #</code></p>
<p><img src= "/img/loading.gif" data-src="https://wx3.sinaimg.cn/mw690/006rXvS1ly1g7exdjvo8mj30mf0etaaf.jpg" alt=""></p>
<p>②猜字段数</p>
<p><code>&#39;order by 4 #&#39;</code>不报错<img src= "/img/loading.gif" data-src="https://wx1.sinaimg.cn/mw690/006rXvS1ly1g7exdju2cmj30n20a2glu.jpg" alt=""></p>
<p><code>&#39;order by 5 #&#39;</code>报错</p>
<p><img src= "/img/loading.gif" data-src="https://wx2.sinaimg.cn/mw690/006rXvS1ly1g7exdju6kwj314g0bot9g.jpg" alt=""></p>
<p>说明字段数为5</p>
<p>③猜内容</p>
<p><img src= "/img/loading.gif" data-src="https://wx2.sinaimg.cn/mw690/006rXvS1ly1g7exdjue0cj30tk0hwgmc.jpg" alt=""></p>
<h1 id="union注入"><a href="#union注入" class="headerlink" title="union注入"></a>union注入</h1><h2 id="union注入攻击"><a href="#union注入攻击" class="headerlink" title="union注入攻击"></a>union注入攻击</h2><p>union注入攻击测试地址：<a href="https://127.0.0.1/union.php?id=1" target="_blank" rel="noopener">https://127.0.0.1/union.php?id=1</a></p>
<p>访问该网址时，页面返回结果。</p>
<p><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/093001.png" alt=""></p>
<p>在url后添加一个单引号，再次访问，页面返回结果与id=1的结果不同</p>
<p><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd//img/093002.png" alt=""><br>访问id =1 and 1=1时，由于and 1=1为真，所以页面应返回与id=1相同的结果。访问id=1 and 1=2时，由于and 1=2为假，所以页面应返回与id=1不同的结果。<br><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/093003.png" alt=""></p>
<p><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/093004.png" alt=""><br>可以得出该网站存在sql注入。使用order by 1-99语句查询该数据表的字段数量，可以理解为order by=1-99，如访问id=1 order  by 4，页面返回与id=1相同的结果。访问id=1 order by 5，页面返回与id=1不同的结果，则字段数为4。<br><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/093005.png" alt=""></p>
<p><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/093006.png" alt=""><br>在数据库查询参数id对应的内容，然后将数据库的内容输出到页面，由于是将数据输出到页面上的，所以可以使用union注入，且通过order by查询结果，得到字段数4，所以union的注入语句</p>
<p>可以看到页面成功执行，但是没有返回union select的结果，这是由于代码只返回第一条结果，所以union select获取的结果没有输出到也面。<br><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/093007.png" alt=""><br>可以通过设置参数id值，让服务端返回union select的结果，例如，把id的值设置为-1，这样数据库中没有id=-1的数据，所以会返回union select的结果。<br><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/093008.png" alt=""><br>返回的结果为2:4，意味着在union select1,2,3,4中，2和4的为止可以输入mysql语句。在2的为止查询当前数据库名（使用database()函数），访问id=-1 union select 1,database(),3,4，页面成功返，回了数据库信息。<br><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/093009.png" alt=""><br>得出了数据库库名后，接下来输入以下命令查询表名。</p>
<p>尝试在2的位置粘贴语句，这里需要加上括号，页面返回了数据库的第一个表名。如果需要看第二个表名，则修改limit中的第一位数字，例如使用limit 1,1就可以获取数据库的第二个表名。<br><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/093010.png" alt=""><br>已知库名和表名，开始查询字段名，查询语句如下所示。</p>
<p>尝试在2的位置粘贴语句，括号还是不可少，获取了users表的第一个字段名，通过使用limit 1,1，获取了users表的第二个字段名。<br><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/093011.png" alt=""></p>
<p><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd//img/093012.png" alt=""><br>当获取了库名、表名和字段名时，就可以构造sql语句查询数据库的数据，例如查询字段username对应的数据。</p>
<p><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/093013.png" alt=""></p>
<h2 id="union注入代码分析"><a href="#union注入代码分析" class="headerlink" title="union注入代码分析"></a>union注入代码分析</h2><p>在union注入页面中，程序获取get参数id，将id拼接到sql语句中，在数据库中查询参数id对应的内容，然后将第一条查询结果中的username和adderss输出到页面，由于是将数据输出到页面上，所以可以利用union语句查询其他数据，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$con=mysqli_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"test"</span>);</span><br><span class="line"><span class="comment">// 检测连接</span></span><br><span class="line"><span class="keyword">if</span> (mysqli_connect_errno())</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"连接失败: "</span> . mysqli_connect_error();</span><br><span class="line">&#125;</span><br><span class="line">$id = $_GET[<span class="string">'id'</span>];</span><br><span class="line">$result = mysqli_query($con,<span class="string">"select * from users where `id`="</span>.$id);</span><br><span class="line"><span class="keyword">if</span>(! $result)&#123;</span><br><span class="line">printf(<span class="string">"Error: %s\n"</span>, mysqli_error($con));</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">$row = mysqli_fetch_array($result);</span><br><span class="line"><span class="keyword">echo</span> $row[<span class="string">'username'</span>] . <span class="string">":"</span> . $row[<span class="string">'address'</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>当访问id=1 union select 1,2,3时，执行的sql语句为：</p>
<p><code>select * from users where id=1 union select 1,2,3;</code></p>
<p>此时sql语句可疑分为select * from users where id`=1和union select 1,2,3两条，利用第二条语句（union查询）就可以获取数据库中的数据。</p>
<h1 id="Boolean注入"><a href="#Boolean注入" class="headerlink" title="Boolean注入"></a>Boolean注入</h1><h2 id="Boolean注入攻击"><a href="#Boolean注入攻击" class="headerlink" title="Boolean注入攻击"></a>Boolean注入攻击</h2><p>Boolean注入攻击的测试地址：<a href="http://127.0.0.1/Boolean.php?id=1。" target="_blank" rel="noopener">http://127.0.0.1/Boolean.php?id=1。</a></p>
<p>访问该网址时，页面返回yes。</p>
<p><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/100501.png" alt=""></p>
<p>在url后添加一个单引号，再次访问，发现返回结果由yes变成no。</p>
<p><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/100502.png" alt=""></p>
<p>访问id=1’ and 1=1%23，id=1’ and 1=2%23，发现返回的结果分别是yes和no，更改id的值，发现返回的任然是yes或者no，由此可判断，页面只返回yes或no，而没有返回数据库中的数据，所以此处不可使用union注入。此处可疑尝试利用boolean注入，boolean注入是指构造sql判断语句，通过查看页面的返回结果来推测哪些sql判断条件是成立的，以此获取数据库中的数据，我们先判断数据库名的长度，语句如下所示。</p>
<p>有单引号，所以需要注释符来注释。1的位置上可以是任意数字，如’and length(database())&gt;=4–+和’and length(database())&gt;=5–+，我们可疑构造这样的语句，然后观察页面的返回结果。<img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/100503.png" alt=""></p>
<p><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/100504.png" alt=""></p>
<p>然后可以发现当数值为4时，返回的结果是yes；当数值为5时，返回的结果时no。整个语句的意思时，数据库库名的长度大于等于4，结果为yes；大于等于5，结果为no，由此判断出数据库库名的长度为4。</p>
<p>接着，使用逐字判断的方式获取数据库库名。数据库库名的范围一般在a<del>z、0</del>9之内，可能还有一些特殊字符，这里的字母不区分大小写。逐字判断的sql语句为：</p>
<p><code>and substr(database(),1,1)=&#39;t&#39;--+</code></p>
<p>substr是截取的意思，其意思是截取database()的值，从第一个字符开始，每次返回一个。</p>
<p>substr的用法跟limit的有区别，需要注意。limit是从0开始排序，而这里从1开始排序。可以使用Burp的爆破功能爆破其中的t值，发现当值是t时，页面返回yes，其他值均返回no，因此判断数据库库名的第一位为t。<img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/100505.png" alt=""></p>
<p>其实还可以使用ASCII码的字符进行查询，t的ASCII码是116，而在mysql中，ASCII的转换函数为ord，则逐字判断的sql语句应该为。</p>
<p><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/100507.png" alt=""><br>从union注入中我们已经知道，数据库名是test，因此判断第二位字母是否是e，可以使用以下语句。返回的结果是yes</p>
<p><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/100508.png" alt=""><br>查询表名、字段名的语句 也应该粘贴在database()的位置，从union注入中已经知道数据库test的第一个表名是users，第一个字母应该是u，判断语句如下所示。</p>
<p>以此类推，就可以查询出所有的表名与字段名。<br><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/100510.png" alt=""></p>
<h2 id="Boolean注入代码分析"><a href="#Boolean注入代码分析" class="headerlink" title="Boolean注入代码分析"></a>Boolean注入代码分析</h2><p>在Boolean注入页面中程序先获取get参数id，通过preg_match判断其中是否存在union/sleep/benchmark等危险字符。然后将参数id拼接到sql语句，从数据库中查询，如果有结果，则返回yes，负责返回no。当访问该页面时，代码根据数据库查询结果返回yes或no，而不返回数据库中的任何数据，所以页面上只会显示yes或no，代码如下所示。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$con=mysqli_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"test"</span>);</span><br><span class="line"><span class="keyword">if</span> (mysqli_connect_errno())</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"连接失败: "</span> . mysqli_connect_error();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$id = $_GET[<span class="string">'id'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/union|sleep|benchmark/i"</span>, $id)) &#123;</span><br><span class="line">	<span class="keyword">exit</span>(<span class="string">"no"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$result = mysqli_query($con,<span class="string">"select * from users where `id`='"</span>.$id.<span class="string">"'"</span>);</span><br><span class="line"><span class="keyword">if</span>(! $result)&#123;</span><br><span class="line">printf(<span class="string">"Error: %s\n"</span>, mysqli_error($con));</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">$row = mysqli_fetch_array($result);</span><br><span class="line"><span class="keyword">if</span> ($row) &#123;</span><br><span class="line">	<span class="keyword">exit</span>(<span class="string">"yes"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">exit</span>(<span class="string">"no"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>当访问id=1’ or 1=1 %23时，数据库执行语句为select * from users where id=’1’ or 1=1 #，由于 or 1=1是永真条件，所以此时页面肯定会返回yes。当访问id=1’ and 1=2 %23时，数据库执行语句为select * from users where id =’1’ and 1=2 #，由于1=2是永假条件，所以此时页面肯定会返回no（由于mysql版本不一致，我这里返回的是一个错误提示）。</p>
<h1 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h1><h2 id="报错注入攻击"><a href="#报错注入攻击" class="headerlink" title="报错注入攻击"></a>报错注入攻击</h2><p>报错注入攻击的测试地址：<a href="http://127.0.0.1/error.php?username=1。" target="_blank" rel="noopener">http://127.0.0.1/error.php?username=1。</a></p>
<p>首先访问<a href="http://127.0.0.1/error.php?username=1&#39;，因为参数username的值是1&#39;，在数据库中执行sql时，会因为多了一个单引号而报错。" target="_blank" rel="noopener">http://127.0.0.1/error.php?username=1&#39;，因为参数username的值是1&#39;，在数据库中执行sql时，会因为多了一个单引号而报错。</a><br><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/100801.png" alt=""><br>通过页面返回结果可以看出，程序直接将错误信息输出到了页面上，所以此处可以利用报错注入获取数据。报错注入有多种格式，此处利用函数updatexml()演示sql语句获取user()的值。</p>
<p>其中0x7e是ASCII编码，解码结果为~。<br><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/100802.png" alt=""><br>然后尝试获取当前数据库的库名。</p>
<p><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/100803.png" alt=""><br>接着可以利用select语句继续获取数据库中的库名、表名和字段名，查询语句与union注入的相同。因为报错注入只显示一条结果，所以需要使用limit语句。构造的语句如下所示。</p>
<p>​    可以获取数据库的库名。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/100804.png" alt=""><br>构造查询表名的语句，可以获取数据库test的表名。</p>
<p><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/100805.png" alt=""></p>
<h2 id="报错注入代码分析"><a href="#报错注入代码分析" class="headerlink" title="报错注入代码分析"></a>报错注入代码分析</h2><p>在报错注入页面中，程序获取get参数username后，将username拼接到sql语句中，然后到数据库查询。如果执行成功，就输出ok；如果出错，则通过echo mysqli_error($con)将错误信息输出到页面（mysqli_error返回上一个mysql函数的错误）。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$con=mysqli_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"test"</span>);</span><br><span class="line"><span class="comment">// 检测连接</span></span><br><span class="line"><span class="keyword">if</span> (mysqli_connect_errno())</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"连接失败: "</span> . mysqli_connect_error();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = $_GET[<span class="string">'username'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($result = mysqli_query($con,<span class="string">"select * from users where `username`='"</span>.$username.<span class="string">"'"</span>))&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"ok"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">echo</span> mysqli_error($con);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>输入username=1’时，sql语句为select * from users where username=’1’’。执行时，会因为多了一个单引号而报错。利用这种错误回显，我么可以通过floor()、updatexml()等函数将要查询的内容输出到页面上。</p>
<h1 id="时间注入"><a href="#时间注入" class="headerlink" title="时间注入"></a>时间注入</h1><h2 id="时间注入攻击"><a href="#时间注入攻击" class="headerlink" title="时间注入攻击"></a>时间注入攻击</h2><p>时间注入攻击的测试地址：<a href="http://127.0.0.1/time.php?id=1。" target="_blank" rel="noopener">http://127.0.0.1/time.php?id=1。</a><br>访问该网址时，页面返回yes，在网址的后面加上一个单引号，再次访问，页面返回no。这个结果与Boolean’注入非常相似，时间注入与Boolean注入的不同之处在于，时间注入时利用sleep()或benchmark()等函数让mysql的执行时间边长。时间盲注多与if(expre1,expre2,expre3)结合使用，此if语句的含义时：如果expre1是ture，则if()的返回值是expre2；否则返回值是expre3。所以此判断数据库库名长度的语句应为：<br><code>and if(length(database())&gt;1,sleep(5),1) --+</code><br>​上面这行语句的意思是，如果数据库的库名长度大于1，则mysql查询休眠5秒，否则查询1。<br>​而查询1的结果，大约只有几十毫秒，根据Burp中的页面响应时间，可以判断条件是否正确。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/101001.png" alt=""><br>​可以看出，页面的响应时间是6016毫秒，也就是6.016秒，表名页面成功执行了sleep(5)，所以长度是大于1的，我们将判断数据库库名长度语句中的值改为10。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/101002.png" alt=""><br>​可以看出，执行的时间是1.018秒，表名页面没有执行sleep(5)，而是执行了select 1，所以数据库的库名长度大于10是错误的。通过多次测试，就可以得到数据库库名的长度。得出数据库库名长度后，我们开始查询数据库库名的第一位字母。查询的语句跟Boolean盲注的类似，使用substr函数，这时的语句应修改为：<br><code>and if (substr(database(),1,1)=&#39;t&#39;,sleep(5),1) --+</code><br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/101003.png" alt=""><br>​可以看出，程序延迟了5秒才返回，说明数据库库名的第一位数字是s，以此类推即可得出完整的数据库的库名、表名、字段名和具体数字。</p>
<h2 id="时间注入代码分析"><a href="#时间注入代码分析" class="headerlink" title="时间注入代码分析"></a>时间注入代码分析</h2><p>在时间注入页面中，程序获取get参数id，通过preg_match判断参数id中是否存在union危险字符，然后将参数id拼接到sql语句中。从数据库中查询sql语句，如果有结果，则返回yes，否则返回no。当访问该页面时，代码根据数据库查询结果返回yes或no，而不返回数据库中的任何数据，所以页面上只会显示yes或no，和Boolen注入不同的是，此处没有过滤sleep等字符。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$con=mysqli_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"test"</span>);</span><br><span class="line"><span class="keyword">if</span>(mysqli_connect_error())&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"连接失败："</span>.mysqli_connect_error();</span><br><span class="line">&#125;</span><br><span class="line">$id=$_GET[<span class="string">'id'</span>];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/union/i"</span>, $id))&#123;</span><br><span class="line">	<span class="keyword">exit</span>(<span class="string">"&lt;html&gt;&lt;body&gt;no&lt;/body&gt;&lt;/html&gt;"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$result=mysqli_query($con,<span class="string">"select * from users where `id`='"</span>.$id.<span class="string">"'"</span>);</span><br><span class="line">$row=mysqli_fetch_array($result);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($row)&#123;</span><br><span class="line">	<span class="keyword">exit</span>(<span class="string">"&lt;html&gt;&lt;body&gt;yes&lt;/body&gt;&lt;/html&gt;"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">exit</span>(<span class="string">"&lt;html&gt;&lt;body&gt;no&lt;/body&gt;&lt;/html&gt;"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>此处仍然可以用Boolean盲注或其他注入方法，下面用时间注入演示。当访问id=1’ and if(ord(substring(user(),1,1))=114,sleep(5),1)%23时，执行的sql语句为：<br><code>select * from users where id=&#39;1&#39; and if(ord(substring(user(),1,1))=114,sleep(5),1)%23</code><br>​由于user()为root，root第一个字符r的ASCII值是114，所以sql语句中if条件成立，执行sleep(5)，页面会延迟5秒，通过这种延迟即可判断sql语句的执行结果。</p>
<h1 id="堆叠查询"><a href="#堆叠查询" class="headerlink" title="堆叠查询"></a>堆叠查询</h1><h2 id="堆叠查询注入攻击"><a href="#堆叠查询注入攻击" class="headerlink" title="堆叠查询注入攻击"></a>堆叠查询注入攻击</h2><p>堆叠查询注入攻击的测试地址：<a href="http://127.0.0.1/dd.php?id=1" target="_blank" rel="noopener">http://127.0.0.1/dd.php?id=1</a><br>​堆叠查询可以执行多条语句，多语句之间以分号隔开。堆叠查询注入就是利用这个特点，在第二个SQL语句中构造自己要执行的语句。首先访问id=1’，页面返回mysql错误，再访问id=1’%23，页面返回正常结果。这里使用Boolean注入，时间注入，也可以使用另外一种注入方式–堆叠注入。<br>​    堆叠注入的语句为：<br><code>;select if (substr(user(),1,1)=&#39;r&#39;,sleep(3),1) %23</code><br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111101.png" alt=""><br>​后面获取数据库的操作与时间注入的一样，通过构造不同的 时间注入语句，可以得到完整的数据库的库名、表名、字段名和具体数据。执行以下语句，就可以获取数据库的表名。<br><code>;select if(substr((select table_name from information_schema.tables where table_schema=database()limit 0,1),1,1)=&#39;e&#39;,sleep(5),1) %23</code><br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111102.png" alt=""></p>
<h2 id="堆叠查询注入代码分析"><a href="#堆叠查询注入代码分析" class="headerlink" title="堆叠查询注入代码分析"></a>堆叠查询注入代码分析</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $conn = <span class="keyword">new</span> PDO(<span class="string">"mysql:host=localhost;dbname=security"</span>, <span class="string">"root"</span>, <span class="string">"root"</span>);</span><br><span class="line">    $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);</span><br><span class="line">    $stmt = $conn-&gt;query(<span class="string">"SELECT * FROM users where `id` = '"</span> . $_GET[<span class="string">'id'</span>] . <span class="string">"'"</span>);</span><br><span class="line"></span><br><span class="line">    $result = $stmt-&gt;setFetchMode(PDO::FETCH_ASSOC);</span><br><span class="line">    <span class="keyword">foreach</span>($stmt-&gt;fetchAll() <span class="keyword">as</span> $k=&gt;$v) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($v <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            <span class="keyword">echo</span> $value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $dsn = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span>(PDOException $e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"error"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$conn = <span class="keyword">null</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用PDO执行sql语句时，可以执行多条语句，不过这样通常不能直接得到注入结果，因为PDO只会返回第一条sql语句执行的结果，所以在第二条语句中可以用update更新数据或者使用时间盲注获取数据。访问dd.php?id=1’;select if(ord(substring(user(),1,1))=114,sleep(3),1);%23时，执行的sql语句为：<br><code>select * from users where id=1;select if(ord(substring(user(),1,1))=114,sleep(3),1);#</code><br>​此时sql语句分为了两句，第一条select * from users where id=’1’是代码自己的select语句，而select if(ord(substring(user(),1,1))=114,sleep(3),1);#则是我们构造的时间盲注的语句。</p>
<h1 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h1><h2 id="二次注入攻击"><a href="#二次注入攻击" class="headerlink" title="二次注入攻击"></a>二次注入攻击</h2><p>二次注入攻击的测试地址：<a href="http://127.0.0.1/double1.php?username=test和" target="_blank" rel="noopener">http://127.0.0.1/double1.php?username=test和</a><br><a href="http://127.0.0.1/double2.php?id=10。其中，1.php页面的功能是注册用户名，也就是插入sql语句的地方；2.php页面的功能是通过参数ID获取用户名和用户信息。" target="_blank" rel="noopener">http://127.0.0.1/double2.php?id=10。其中，1.php页面的功能是注册用户名，也就是插入sql语句的地方；2.php页面的功能是通过参数ID获取用户名和用户信息。</a><br>访问1.php?username=test’<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111401.png" alt=""><br>从页面返回结果可以看到用户名test’，对应的ID为25，访问2.php?id=25<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111402.png" alt=""><br>    从返回结果可以看到服务端返回了mysql的错误（多了一个单引号引起的语法错误），这是回到第一步，先访问1.php?username=test’ order by 1%23，获取一个新的id=39，当再次访问2.php?id=39时，页面返回空白；再次访问1.php?username=test’ order by 10 %23，获取一个新的id=40，当再次访问2.php?id=40时，页面返回错误信息（unknown column ‘10’ in ‘order clause’）。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111403.png" alt=""><br>    这说明空白页就是正常返回，通过不断的尝试，判断出数据库表中一共有3个字段，访问1.php?username=test’ union select 1,2,3%23，获取一个新的id=41，再访问2.php?id=41，发现页面返回了union select中的1和2字段。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111404.png" alt=""><br>    在1或2的位置，插入注入语句，访问1.php?username=test’ union select 1,user()%23，获得新的id=40，得到user()的结果，使用此方法就可以获取数据库中的数据。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111405.png" alt=""></p>
<h2 id="二次注入代码分析"><a href="#二次注入代码分析" class="headerlink" title="二次注入代码分析"></a>二次注入代码分析</h2><p>二次注入中1.php页面的代码如下所示，实现了简单的用户注册功能，程序获取到GET参数username和参数password，然后将username和password拼接到sql语句，使用insert语句插入数据库中。由于参数username使用addslashes进行转义（转义了单引号，导致单引号无法闭合），参数password进行了MD5哈希，所以此处不存在SQL注入漏洞。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$con=mysqli_connect(<span class="string">"127.0.0.1"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"test"</span>); </span><br><span class="line">	<span class="keyword">if</span>(mysqli_connect_error())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"连接失败"</span>.mysql_connect_error();</span><br><span class="line">	&#125;</span><br><span class="line">	$username=$_GET[<span class="string">'username'</span>];</span><br><span class="line">	$password=$_GET[<span class="string">'password'</span>];</span><br><span class="line">	$result=mysqli_query($con,<span class="string">"insert into users(`username`,`password`) values('"</span>.addslashes($username).<span class="string">"','"</span>.md5($password).<span class="string">"')"</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"新ID为："</span>.mysqli_insert_id($con);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问usernmae=test’&amp;password=123456时，执行的sql语句为：<br>insert into users (`username`,`password`)values(‘test’’,’e10adc3949ba59abbe56’)<br>可以看到，插入的用户名test’。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111406.png" alt=""><br>​在二次注入中，2.php中的代码如下所示，首先将GET参数ID转成int类型（防止拼接到sql语句时，存在sql注入漏洞），然后到users表中获取ID对应的username，接着到person表中查询username对应的数据</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$con=mysqli_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"test"</span>);</span><br><span class="line">	<span class="keyword">if</span>(mysqli_connect_error())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"连接失败"</span>.mysql_connect_error();</span><br><span class="line">	&#125;</span><br><span class="line">	$id=intval($_GET[<span class="string">'id'</span>]);</span><br><span class="line">	$result=mysqli_query($con,<span class="string">"select * from users where `id`="</span>.$id);</span><br><span class="line">	$row=mysqli_fetch_array($result);</span><br><span class="line">	$username=$row[<span class="string">'username'</span>];</span><br><span class="line">	$result2=mysqli_query($con,<span class="string">"select * from person where `username`='"</span>.$username.<span class="string">"'"</span>);</span><br><span class="line">	<span class="keyword">if</span> ($row2=mysqli_fetch_array($result2)) &#123;</span><br><span class="line">		<span class="keyword">echo</span> $row2[<span class="string">'username'</span>].<span class="string">":"</span>.$row2[<span class="string">'email'</span>];</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> mysqli_error($con);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是此处没有对$username进行转义，在第一步中注册的用户名是test’，此时执行的sql语句为：<br><code>select * from person shere username=&#39;test&#39;&#39;</code><br>单引号被带入sql语句中，由于多了一个单引号，所以页面会报错。</p>
<h1 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h1><h2 id="宽字节注入攻击"><a href="#宽字节注入攻击" class="headerlink" title="宽字节注入攻击"></a>宽字节注入攻击</h2><p>宽字节注入攻击的测试地址：<a href="http://127.0.0.1/kzj.php?id=1" target="_blank" rel="noopener">http://127.0.0.1/kzj.php?id=1</a><br>访问id=1’，程序并没有报错，反而多了一个转义符（反斜杠）。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111601.png" alt=""><br>从返回的结果可以看出，参数id=1在数据库中查询时被单引号包围的。当传入id=1’时，传入的单引号又被转义符（反斜线）转义，导致参数id无法逃逸单引号的包围，所以在一般情况下，此处是不窜在sql注入漏洞的。不过有一个特列，就是当数据库的编码为GBK时，可以使用宽字节注入，宽字节的格式时在地址后现价一个%df，再加单引号，因为反斜杠的编码为%5c，而在GBK编码中，%df%5c是繁体字“連”，所以这时，单引号成功逃逸，报错mysql数据库的错误。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111602.png" alt=""><br>由于输入的参数id=1’，导致sql语句多了一个单引号，所以需要使用注释符来注释程序自身的单引号。访问id=1%df’%23，可以看到sql语句已经符合语法规范。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111603.png" alt=""><br>使用and 1=1和and1=2进一步判断注入，访问id=1%df’and 1=1%23和id=1%df’and 1=2%23<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111604.png" alt=""><br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111605.png" alt=""><br>当and 1=1程序返回正常时，and 1=2程序返回错误，所以判断该参数ID存在sql注入漏洞，接着使用order by查询数据库表的字段数量，最后得知字段数为4。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111606.png" alt=""><br>因为页面直接显示了数据库中的内容，所以可以使用union查询。与union注入一样，此时的union语句时union select ,1,2,3,4，为了让页面返回union查询的结果，需要把ID的值改为负数。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111607.png" alt=""><br>然后尝试在页面2的位置查询当前数据库的库名（database()）.<br>id=-1%df’union select 1,user(),3,4%23<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111608.png" alt=""><br>查询数据库的库名。</p>
<p>但是此时，由于单引号被转义，会自动多出反斜杠，导致sql语句出错，所以此需要利用另一种方法：嵌套查询。就是在一个查询语句中，再添加一个查询语句。</p>
<p>可以看到，原本的table_schema=’test’变成了table_schema=(select database())，因为select database()的结果就是’test’，这就是嵌套查询。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111609.png" alt=""><br>从返回结果可以看到，数据库的第一个表名是person，如果想查询后面的表名，还需要修改limit后的数字。或使用group_concat()函数，查询所有表名。<br><img src= "/img/loading.gif" data-src="https://cdn.jsdelivr.net/gh/ChakaLake/ywd/img/111610.png" alt=""><br>使用以下语句查询users表中的字段。</p>
<p>这里使用了三层嵌套，，第一层是table_schema，代表库名的嵌套，第二层和第三层是table_name的嵌套。语句中有两个limit，前一个limit是控制表名的顺序，后一个则控制字段名的顺序。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111611.png" alt=""></p>
<h2 id="宽字节注入代码分析"><a href="#宽字节注入代码分析" class="headerlink" title="宽字节注入代码分析"></a>宽字节注入代码分析</h2><p>在宽字节注入页面中，程序获取参数ID，并对参数ID使用addslashes()转义，然后拼接到sql语句中，进行查询</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$conn = mysql_connect(<span class="string">'localhost'</span>, <span class="string">'root'</span>, <span class="string">'root'</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'bad!'</span>);</span><br><span class="line">mysql_select_db(<span class="string">'test'</span>, $conn) <span class="keyword">OR</span> emMsg(<span class="string">"数据库连接失败"</span>);</span><br><span class="line">mysql_query(<span class="string">"SET NAMES 'gbk'"</span>,$conn);</span><br><span class="line">$id = addslashes($_GET[<span class="string">'id'</span>]);</span><br><span class="line">$sql=<span class="string">"SELECT * FROM users WHERE id='$id' LIMIT 0,1"</span>;</span><br><span class="line">$result = mysql_query($sql, $conn) <span class="keyword">or</span> <span class="keyword">die</span>(mysql_error()); </span><br><span class="line">$row = mysql_fetch_array($result);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>($row)</span><br><span class="line">	&#123;</span><br><span class="line">  	<span class="keyword">echo</span> $row[<span class="string">'username'</span>] . $row[<span class="string">'address'</span>];</span><br><span class="line">  	&#125;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">	&#123;</span><br><span class="line">	print_r(mysql_error());</span><br><span class="line">	&#125;      </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/font&gt; </span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;The Query String is : "</span>.$sql .<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>当访问id=1’时，执行的sql语句为<br><code>select * from users where id=&#39;1\&#39;&#39;</code><br>​可以看到单引号被转义符“\”转义，所以在一般情况下，是无法注入的，但由于在数据库查询前执行了set names ‘GBK’，将编码设置为宽字节GBK，所以此处存在宽字节注入漏洞。<br>​在PHP中，通过iconv()进行编码转换时，也可能存在宽字节注入漏洞。</p>
<h1 id="cookie注入"><a href="#cookie注入" class="headerlink" title="cookie注入"></a>cookie注入</h1><h2 id="cookie注入攻击"><a href="#cookie注入攻击" class="headerlink" title="cookie注入攻击"></a>cookie注入攻击</h2><p>cookie注入攻击测试地址：<a href="http://127.0.0.1/cookie.php" target="_blank" rel="noopener">http://127.0.0.1/cookie.php</a><br>​发现URL中没有GET参数，但是页面返回正常，使用Burp suit抓取数据包，发现cookie中存在id=1的参数。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111701.png" alt=""><br>​修改cookie中的id=1为id=1’，然后再次访问该URL，发现页面返回错误。接下来，分别修改cookie中的id=1为id=1 and 1=1和id=1 and 1=2，再次访问，判断该页面是否存在sql注入漏洞，得到cookie中的参数ID存在sql注入的结论。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111702.png" alt=""><br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/1171703.png" alt=""><br>​接着使用order by查询字段，使用union注入方法完成此次注入。</p>
<h2 id="cookie注入代码分析"><a href="#cookie注入代码分析" class="headerlink" title="cookie注入代码分析"></a>cookie注入代码分析</h2><p>通过$_COOKIE能获取浏览器cookie中的数据，在cookie注入页面中程序通过$__cookie获取参数id，然后直接将id拼接到select语句中进行查询，如果有结果，则将结果输出到页面。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$id=$_COOKIE[<span class="string">'id'</span>];</span><br><span class="line">$value=<span class="string">"1"</span>;</span><br><span class="line">setcookie(<span class="string">"id"</span>,$value);</span><br><span class="line">$con=mysqli_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"test"</span>);</span><br><span class="line"><span class="keyword">if</span>(mysqli_connect_error())</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"连接失败："</span>.mysqli_connect_error();</span><br><span class="line">&#125;</span><br><span class="line">$result=mysqli_query($con,<span class="string">"select * from users where `id`="</span>.$id);</span><br><span class="line"><span class="keyword">if</span>(!$result)&#123;</span><br><span class="line">	printf(<span class="string">"Error:%s\n"</span>,mysqli_error($con));</span><br><span class="line">	<span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">$row=mysqli_fetch_array($result);</span><br><span class="line"><span class="keyword">echo</span> $row[<span class="string">'username'</span>].<span class="string">":"</span>.$row[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于没有过滤cookie中的参数id且直接拼接到sql语句中，所以存在sql注入漏洞。当cookie中添加id=1 union select 1,2,3,4%23时，执行的sql语句为：<br><code>select * from users where id=1 union select 1,2,3,4 #</code><br>​此时，sql语句可以分为select * from usere where id=1和union select 1,2,3两条，利用第二条语句就可以获取数据库</p>
<h1 id="base64注入"><a href="#base64注入" class="headerlink" title="base64注入"></a>base64注入</h1><h2 id="base64注入攻击"><a href="#base64注入攻击" class="headerlink" title="base64注入攻击"></a>base64注入攻击</h2><p>测试地址：<a href="http://127.0.0.1/base.php?id=MQ==" target="_blank" rel="noopener">http://127.0.0.1/base.php?id=MQ==</a><br>​从url中可以看出，ID参数经过base64编码，解码后发现ID为1，尝试加上一个单引号并一起转成base64编码。当访问id=1’编码后的网址（<a href="http://127.0.0.1/base.php?id=MSc=），页面返回错误。" target="_blank" rel="noopener">http://127.0.0.1/base.php?id=MSc=），页面返回错误。</a><br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111704.png" alt=""><br>​    1 and 1=1和1 and 1=2的base64编码分别为MSBhbmQgMT0x和MSBhbmQgMT0y<br>再次访问id=MSBhbmQgMT0y和id=MSBhbmQgMT0y。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111705.png" alt=""></p>
<p><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111706.png" alt=""><br>从返回结果可以看到，访问id=1 and 1=1时，页面返回与id=1相同的结果，而访问id=1 and 1=2时，页面返回与id=1不同的结果，所以该网页存在sql注入漏洞。<br>接着，使用order by查询字段，使用union方法完成注入。</p>
<h2 id="base64注入代码分析"><a href="#base64注入代码分析" class="headerlink" title="base64注入代码分析"></a>base64注入代码分析</h2><p>在base64注入页面中，程序获取GET参数ID，利用base64_decode()对参数ID进行base64解码，然后直接将解码后的$id拼接到sql语句中进行查询，通过while循环将查询结果输出到页面。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$id=base64_decode($_GET[<span class="string">'id'</span>]);</span><br><span class="line">$conn=mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(<span class="string">"test"</span>,$conn);</span><br><span class="line">$sql=<span class="string">"select * from users where id=$id"</span>;</span><br><span class="line">$result=mysql_query($sql);</span><br><span class="line"><span class="keyword">while</span>($row=mysql_fetch_array($result))&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"ID:"</span>.$row[<span class="string">'id'</span>].<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"user"</span>.$row[<span class="string">'username'</span>].<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"pass"</span>.$row[<span class="string">'password'</span>].<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"&lt;hr&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">mysql_close($conn);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"now use:"</span>.$sql.<span class="string">"&lt;hr&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    由于代码没有过滤解码后的$id，且将$id拼接到sql语句中，所以存在sql注入漏洞。当访问id=1 union select 1,2,3,4#（先进行base64编码）时，执行的sql为<br><code>select * from users where id=1 union select 1,2,3,4#</code><br>​此时，sql语句可以分为select * from users where id=1和union select 1,2,3,4<br>两条，利用第二条语句（union查询）就可以获取数据库中的数据。<br>​这种攻击方式还有其他利用场景，例如，如果有WAF，则WAF会对传输中的参数ID进行检查，但由于传输中的ID经过base64编码，所以此时WAF很有可能检测不到危险代码，进而绕过了WAF检测。</p>
<h1 id="XFF注入"><a href="#XFF注入" class="headerlink" title="XFF注入"></a>XFF注入</h1><h2 id="XFF注入攻击"><a href="#XFF注入攻击" class="headerlink" title="XFF注入攻击"></a>XFF注入攻击</h2><p>XFF注入攻击的测试地址：<a href="https://127.0.0.1/xff.php" target="_blank" rel="noopener">https://127.0.0.1/xff.php</a><br>​通过Burp Suit抓取数据包内容，可以看到HTTP请求头中有一个头部参数<br>X-Forwarded-for。X-Forwarded-for简称XFF头，它代表客户端的真实IP，然后通过X-Forwarded-for的值可以伪造客户端IP，将X-Forwarded-for设置为127.0.0.1，然后访问该URL，页面返回正常。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111801.png" alt=""><br>​将X-Forwarded-for设置为127.0.0.1’，再次访问该url，页面返回mysql的错误信息。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111802.png" alt=""><br>​将X-Forwarded-for分贝设置为127.0.0.1’and 1=1#和127.0.0.1’and 1=2#，再次访问该url。<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111803.png" alt=""></p>
<p><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111804.png" alt=""><br>通过页面的 返回结果，可以判断该地址存在sql注入漏洞，接着可以使用order by判断表中的字段数量，最终测试出数据库中存在4个字段，尝试使用union查询注入方法，语法是X-Forwarded-for:1’union select 1,2,3,4,5#<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/111805.png" alt=""><br>接着使用union注入方法完成此次注入。</p>
<h2 id="XFF注入代码分析"><a href="#XFF注入代码分析" class="headerlink" title="XFF注入代码分析"></a>XFF注入代码分析</h2><p>PHP中getenv()函数用于获取一个环境变量的值，类似于$_SERVER或$_ENV，返回环境变量对应的值，如果环境变量不存在则返回FALSE。<br>​使用以下代码即可获取客户端的IP地址，程序先判断是否存在HTTP头部参数HTTP_CLIENT_IP，如果存在，则赋给$ip，如果不存在，则判断是否存在HTTP头部参数HTTP_X_FORWARDED_FOR，如果存在，则赋给$ip，如果不存在，则将HTTP头部的参数REMOTE_ADDR赋给$ip。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  $con=mysqli_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"test"</span>);</span><br><span class="line">  <span class="keyword">if</span> (mysqli_connect_errno())</span><br><span class="line">  &#123;</span><br><span class="line">  	<span class="keyword">echo</span> <span class="string">"连接失败: "</span> . mysqli_connect_error();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(getenv(<span class="string">'HTTP_CLIENT_IP'</span>)) &#123;</span><br><span class="line">    $ip = getenv(<span class="string">'HTTP_CLIENT_IP'</span>);</span><br><span class="line">  &#125; <span class="keyword">elseif</span>(getenv(<span class="string">'HTTP_X_FORWARDED_FOR'</span>)) &#123;</span><br><span class="line">    $ip = getenv(<span class="string">'HTTP_X_FORWARDED_FOR'</span>);</span><br><span class="line">  &#125; <span class="keyword">elseif</span>(getenv(<span class="string">'REMOTE_ADDR'</span>)) &#123;</span><br><span class="line">    $ip = getenv(<span class="string">'REMOTE_ADDR'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $ip = $HTTP_SERVER_VARS[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  $result = mysqli_query($con,<span class="string">"select * from users where `ip`='$ip'"</span>);</span><br><span class="line">  <span class="keyword">if</span> (!$result) &#123;</span><br><span class="line">    printf(<span class="string">"Error: %s\n"</span>, mysqli_error($con));</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  $row = mysqli_fetch_array($result);</span><br><span class="line">  <span class="keyword">echo</span> $row[<span class="string">'username'</span>] . <span class="string">" : "</span> . $row[<span class="string">'password'</span>];</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>接下来，将$ip拼接到select语句，然后将查询结果输出到界面上。<br>​由于HTTP头部参数时可以伪造的，所以可以添加一个头部参数CLIENT_IP或X_FORWARDED_FOR。当设置X_FORWARDED_FOR=1’union select 1,2,3,4%23时，执行的sql语句为：<br><code>select * from usere where ip=&#39;1&#39;union select 1,2,3,4#&#39;</code><br>​此时sql语句可以分为select * from usere where `ip`=1和union select 1,2,3,4,5两条，利用第二条语句（union查询）就可以获取数据库中的数据。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">他年少如歌</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://chakalake.gitee.io/posts/15480/">https://chakalake.gitee.io/posts/15480/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://chakalake.gitee.io" target="_blank">他年少如歌</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/HCLonely/hclonely.github.io/img/Butterfly/004.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/18503/"><img class="prev-cover" data-src="https://cdn.jsdelivr.net/gh/HCLonely/hclonely.github.io/img/Butterfly/040.webp" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Kali|MSF基本操作(更新ing)</div></div></a></div><div class="next-post pull-right"><a href="/posts/20980/"><img class="next-cover" data-src="https://cdn.jsdelivr.net/gh/HCLonely/hclonely.github.io/img/Butterfly/039.webp" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">python学习|python简介</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021  <i id="heartbeat" class="fa fas fa-heartbeat"></i> 他年少如歌</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"><meta name="generator" content="Hexo 4.2.0"></head></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/haruto.model.json"},"display":{"position":"right","width":120,"height":260},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>